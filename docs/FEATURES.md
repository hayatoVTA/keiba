# 機能詳細仕様

## 1. ユーザーシステム

### 1.1 認証方式

#### ゲストモード
- **概要**: アカウント作成なしでプレイ可能
- **制限**:
  - セッション限定（ブラウザを閉じるとデータ消失）
  - ランキング参加不可
  - コイン購入不可
- **初期コイン**: 5,000コイン

#### メール認証
- **概要**: メールアドレスとパスワードでアカウント作成
- **機能**:
  - メール認証（確認メール送信）
  - パスワードリセット
  - プロフィール編集
- **初期コイン**: 10,000コイン

#### ソーシャルログイン
- **対応サービス**:
  - Google
  - Twitter/X
- **機能**:
  - ワンクリックログイン
  - プロフィール情報自動取得
- **初期コイン**: 10,000コイン

### 1.2 ユーザーデータ構造

```typescript
interface User {
  id: string;                    // UUID
  email?: string;                 // メールアドレス（オプション）
  displayName: string;            // 表示名
  avatar?: string;                // アバター画像URL
  coins: number;                  // 現在のコイン保有数
  totalBets: number;              // 総予想数
  totalWins: number;              // 的中数
  totalEarnings: number;         // 総獲得コイン
  totalSpent: number;             // 総消費コイン
  winRate: number;                // 的中率（%）
  rank: number;                   // 現在のランキング順位
  isPremium: boolean;            // プレミアム会員フラグ
  premiumExpiresAt?: Date;        // プレミアム有効期限
  createdAt: Date;                // アカウント作成日時
  lastLoginAt: Date;              // 最終ログイン日時
  consecutiveLoginDays: number;   // 連続ログイン日数
}
```

### 1.3 プロフィール機能

- **表示情報**:
  - アバター
  - 表示名
  - コイン残高
  - 予想統計（総予想数、的中数、的中率）
  - 獲得バッジ
  - ランキング順位
- **編集可能項目**:
  - 表示名
  - アバター
  - メールアドレス（メール認証の場合）

## 2. コインシステム

### 2.1 初期コイン

| ユーザータイプ | 初期コイン |
|--------------|-----------|
| 新規登録 | 10,000コイン |
| ゲストモード | 5,000コイン |

### 2.2 コイン獲得方法

#### 予想的中
- **計算式**: 賭け金 × オッズ（小数点以下切り捨て）
- **例**: 100コイン × 3.5倍 = 350コイン獲得

#### デイリーボーナス
- **金額**: 100コイン/日
- **条件**: 1日1回、ログイン時に自動付与
- **表示**: ログイン時に通知

#### ログインボーナス
- **連続ログイン日数別ボーナス**:
  - 3日連続: +50コイン
  - 7日連続: +200コイン
  - 14日連続: +500コイン
  - 30日連続: +2,000コイン
- **最大**: 30日連続まで

#### 広告視聴
- **金額**: 50コイン/動画
- **制限**: 1日最大5回（250コイン/日）
- **実装**: 動画広告視聴完了後に付与

#### 課金購入
- **レート**: 100円 = 1,000コイン
- **最低購入額**: 500円
- **詳細**: [マネタイズ戦略](./MONETIZATION.md) を参照

#### ランキング報酬
- **詳細**: [ランキングシステム](#25-ランキングシステム) を参照

### 2.3 コイン消費

#### 予想購入
- **最小額**: 10コイン
- **最大額**:
  - 通常ユーザー: 10,000コイン
  - プレミアムユーザー: 50,000コイン
- **制限**: 1レースあたり最大3種類の予想タイプ

#### プレミアム機能
- **詳細分析**: 500コイン/回
  - 過去成績データ
  - 血統情報
  - 騎手・調教師の成績

### 2.4 コイン履歴

- **表示項目**:
  - 日時
  - 種類（獲得/消費）
  - 金額
  - 理由（予想的中、購入、ボーナス等）
  - 残高
- **フィルター**:
  - 期間指定
  - 種類別
  - 金額範囲

## 3. レースデータ管理

### 3.1 データ構造

```typescript
interface Race {
  id: string;                     // UUID
  date: Date;                     // レース日
  venue: string;                  // 競馬場名（例: "東京競馬場"）
  raceNumber: number;             // レース番号
  raceName: string;               // レース名
  grade?: string;                 // グレード（G1, G2, G3等）
  distance: number;               // 距離（m）
  surface: 'turf' | 'dirt';       // 芝/ダート
  condition: string;              // 馬場状態（良、稍重等）
  weather?: string;               // 天候
  horses: Horse[];                // 出走馬一覧
  status: 'upcoming' | 'betting' | 'running' | 'finished' | 'cancelled';
  startTime: Date;                // 発走時刻
  bettingStartTime: Date;         // 予想受付開始時刻
  bettingEndTime: Date;           // 予想受付終了時刻
  result?: RaceResult;            // レース結果
  createdAt: Date;
  updatedAt: Date;
}

interface Horse {
  number: number;                  // 馬番
  name: string;                   // 馬名
  jockey: string;                 // 騎手名
  trainer: string;                // 調教師名
  weight: number;                 // 負担重量（kg）
  odds: number;                   // オッズ（リアルタイム更新）
  popularity: number;             // 人気（1着人気=1）
  age: number;                    // 年齢
  sex: 'male' | 'female';        // 性別
  previousResults?: number[];     // 過去5走の着順
}

interface RaceResult {
  first: number;                  // 1着馬番
  second: number;                 // 2着馬番
  third: number;                  // 3着馬番
  payout: {
    win: number;                  // 単勝配当
    place: number[];              // 複勝配当（3着まで）
    exacta: number;               // 馬連配当
    wide: number;                 // ワイド配当
  };
  finishTime?: string;            // 決勝タイム
}
```

### 3.2 データ取得フロー

#### 定期ジョブ（毎日5:00）
1. 当日のレース一覧を取得
2. 各レースの基本情報を保存
3. 出走馬情報を取得・保存
4. 予想受付開始時刻を設定（レース開始30分前）

#### リアルタイム更新（5分間隔）
1. 予想受付中のレースのオッズを更新
2. 人気順を更新
3. Redisキャッシュを更新

#### レース開始30分前
- 予想受付開始
- フロントエンドに通知

#### レース開始5分前
- 予想受付終了
- 最終オッズ確定

#### レース終了後
1. レース結果を取得
2. 配当を計算
3. 予想結果を判定
4. コインを配布
5. ランキングを更新

### 3.3 レース一覧表示

#### フィルター機能
- **日付**: 今日、明日、今週、来週
- **競馬場**: 全競馬場、特定競馬場
- **グレード**: 全レース、G1のみ、G2のみ等
- **状態**: 予想受付中、予想受付前、終了済み

#### ソート機能
- 発走時刻順（デフォルト）
- 人気順
- オッズ順

#### 表示情報
- レース名
- 競馬場・距離・馬場状態
- 発走時刻
- 予想受付状況
- 出走頭数

## 4. 予想システム

### 4.1 予想タイプ

#### 単勝
- **説明**: 1着を予想
- **選択数**: 1頭
- **配当計算**: 賭け金 × 単勝オッズ

#### 複勝
- **説明**: 3着以内を予想
- **選択数**: 1頭
- **配当計算**: 賭け金 × 複勝オッズ

#### 馬連
- **説明**: 1着・2着の組み合わせを予想
- **選択数**: 2頭
- **配当計算**: 賭け金 × 馬連オッズ

#### ワイド
- **説明**: 3着以内の2頭の組み合わせを予想
- **選択数**: 2頭
- **配当計算**: 賭け金 × ワイドオッズ

### 4.2 予想データ構造

```typescript
interface Bet {
  id: string;                     // UUID
  userId: string;                 // ユーザーID
  raceId: string;                 // レースID
  betType: 'win' | 'place' | 'exacta' | 'wide';
  selections: number[];           // 選択した馬番
  amount: number;                 // 賭け金
  odds: number;                   // 購入時のオッズ
  status: 'pending' | 'won' | 'lost' | 'refunded';
  payout?: number;                // 配当額（的中時）
  createdAt: Date;                // 予想日時
  settledAt?: Date;               // 確定日時
}
```

### 4.3 予想フロー

1. **レース選択**: レース一覧から選択
2. **予想タイプ選択**: 単勝、複勝、馬連、ワイドから選択
3. **馬選択**: 出走馬から選択（タイプに応じて1-2頭）
4. **賭け金入力**: 10コイン〜上限まで
5. **確認画面**: 予想内容と賭け金を確認
6. **確定**: コインを消費して予想確定
7. **結果待ち**: レース終了まで待機
8. **結果確定**: レース終了後、自動的に結果判定・配当計算

### 4.4 配当計算

#### 的中時
- **計算式**: `Math.floor(賭け金 × オッズ)`
- **例**: 100コイン × 3.5倍 = 350コイン獲得

#### 不的中時
- **配当**: 0コイン

#### レース中止時
- **処理**: 返金（賭け金を返却）
- **ステータス**: `refunded`

### 4.5 予想履歴

#### 表示項目
- レース名・日時
- 予想タイプ
- 選択した馬
- 賭け金
- オッズ
- 結果（的中/不的中）
- 配当額

#### フィルター
- 期間指定
- 予想タイプ別
- 結果別（的中/不的中/未確定）

## 5. ランキングシステム

### 5.1 ランキング種類

#### 総資産ランキング
- **基準**: 現在のコイン保有数
- **更新頻度**: リアルタイム
- **表示**: 上位100位

#### 収支ランキング
- **基準**: 総獲得コイン - 総消費コイン
- **更新頻度**: リアルタイム
- **表示**: 上位100位

#### 的中率ランキング
- **基準**: (的中数 / 予想数) × 100
- **条件**: 予想数10回以上
- **更新頻度**: リアルタイム
- **表示**: 上位100位

#### 週間ランキング
- **基準**: 週間の収支
- **期間**: 月曜日0:00〜日曜日23:59
- **更新頻度**: リアルタイム
- **表示**: 上位100位

#### 月間ランキング
- **基準**: 月間の収支
- **期間**: 月初0:00〜月末23:59
- **更新頻度**: リアルタイム
- **表示**: 上位100位

### 5.2 ランキング更新

#### リアルタイム更新
- **トリガー**:
  - 予想確定時
  - コイン獲得時
  - コイン消費時
- **処理**:
  1. ユーザーのランキング指標を再計算
  2. ランキングテーブルを更新
  3. Redisキャッシュを更新

#### 定期更新
- **日次ランキング**: 毎日0:00にリセット
- **週次ランキング**: 毎週月曜日0:00にリセット
- **月次ランキング**: 毎月1日0:00にリセット

### 5.3 ランキング報酬

| 順位 | 報酬 |
|------|------|
| 1位 | 50,000コイン + ゴールドバッジ |
| 2-3位 | 30,000コイン + シルバーバッジ |
| 4-10位 | 10,000コイン + ブロンズバッジ |
| 11-100位 | 5,000コイン |

#### バッジ
- **ゴールドバッジ**: 1位獲得時に付与、プロフィールに表示
- **シルバーバッジ**: 2-3位獲得時に付与
- **ブロンズバッジ**: 4-10位獲得時に付与

### 5.4 ランキング表示

#### 表示項目
- 順位
- ユーザー名・アバター
- ランキング指標（コイン数、収支、的中率等）
- バッジ

#### 機能
- **自分の順位表示**: 現在の順位をハイライト
- **ページネーション**: 20件ずつ表示
- **リアルタイム更新**: 5秒ごとに自動更新

## 6. バッジシステム

### 6.1 バッジ種類

#### ランキングバッジ
- **ゴールド**: ランキング1位
- **シルバー**: ランキング2-3位
- **ブロンズ**: ランキング4-10位

#### 実績バッジ
- **初勝利**: 初めて予想が的中
- **10連勝**: 10回連続で的中
- **大逆転**: 100倍以上のオッズで的中
- **コレクター**: 全競馬場で予想
- **常連**: 30日連続ログイン

#### プレミアムバッジ
- **プレミアム会員**: プレミアム会員限定

### 6.2 バッジ表示
- プロフィールページに表示
- ランキングページに表示
- コメント等で表示可能

